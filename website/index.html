<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç ThreatLens - Executive Security Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: #0a0a0a;
            opacity: 1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #00ff41;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .header-content {
            text-align: center;
        }

        .detective-icon {
            font-size: 4rem;
            filter: drop-shadow(0 0 10px #00ff41);
        }

        .header h1 {
            font-size: 4rem;
            margin-bottom: 15px;
            color: #00ff41;
            text-shadow: 0 0 30px #00ff41;
            font-weight: 700;
        }

        .header p {
            color: #b0b0b0;
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .header .tagline {
            color: #00ff41;
            font-size: 1.1rem;
            font-style: italic;
            opacity: 0.9;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(0, 255, 65, 0.1), rgba(0, 150, 40, 0.1));
            border: 1px solid #00ff41;
            border-radius: 15px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0, 255, 65, 0.2);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }

        .filter-group label {
            color: #00ff41;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }

        select, input {
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(20, 20, 20, 0.9));
            border: 2px solid transparent;
            background-clip: padding-box;
            color: #e0e0e0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        select:focus, input:focus {
            outline: none;
            border-color: #00ff41;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.4), inset 0 2px 4px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        select:hover, input:hover {
            border-color: rgba(0, 255, 65, 0.5);
            transform: translateY(-1px);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            border-color: #00ff41;
        }

        .stat-card h3 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #b0b0b0;
            font-size: 1rem;
        }

        .trend {
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .critical { color: #ff4444; }
        .high { color: #ff8800; }
        .medium { color: #ffcc00; }
        .low { color: #00ff41; }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(20, 20, 20, 0.9);
            border-radius: 8px;
            padding: 5px;
            border: 1px solid #333;
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: #b0b0b0;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            background: #00ff41;
            color: #000;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .table-container {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .table-container h2 {
            color: #00ff41;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            background: rgba(40, 40, 40, 0.8);
            color: #00ff41;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        tr:hover {
            background: rgba(40, 40, 40, 0.3);
        }

        .severity-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .severity-critical { background: #ff4444; color: white; }
        .severity-high { background: #ff8800; color: white; }
        .severity-medium { background: #ffcc00; color: black; }
        .severity-low { background: #00ff41; color: black; }

        .kb-source {
            font-size: 0.8rem;
            color: #888;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #00ff41;
        }

        .chart-container {
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #333;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            height: 300px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 255, 65, 0.1);
        }

        .chart-title {
            color: #00ff41;
            font-size: 1.3rem;
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
            height: 30px;
            font-weight: 600;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        #trendChart {
            flex: 1;
            width: 100%;
            height: 240px;
            border-radius: 8px;
        }

        .matrix-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            pointer-events: none;
        }

        .matrix-overlay canvas {
            width: 100%;
            height: 100%;
        }

        .timestamp-cell {
            color: #00ff41 !important;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
            cursor: pointer;
        }

        .timestamp-cell:hover {
            color: #ffffff !important;
            text-shadow: 0 0 15px #00ff41;
        }
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .clickable-row:hover {
            background: rgba(0, 255, 65, 0.2) !important;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background-color: rgba(20, 20, 20, 0.95);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #00ff41;
            border-radius: 10px;
            width: 90%;
            max-width: 1200px;
            max-height: 80%;
            overflow-y: auto;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
        }

        .close {
            color: #00ff41;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #fff;
        }

        .detail-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(40, 40, 40, 0.5);
            border-radius: 8px;
            border-left: 3px solid #00ff41;
        }

        .detail-title {
            color: #00ff41;
            font-size: 1.3rem;
            margin-bottom: 15px;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 255, 65, 0.3);
        }

        .detail-item {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(60, 60, 60, 0.3);
            border-radius: 5px;
            line-height: 1.6;
        }

        .detail-item h4 {
            color: #00ff41;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .detail-issue {
            margin-left: 20px;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(80, 80, 80, 0.3);
            border-radius: 5px;
            border-left: 2px solid #ff8800;
        }

        .detail-issue p {
            margin-bottom: 8px;
        }

        .detail-issue strong {
            color: #00ff41;
        }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                justify-content: space-between;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1 1 auto;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="matrix-bg">
        <canvas id="matrixCanvas"></canvas>
    </div>

    <div class="container">
        <div class="header">
            <div class="detective-icon">üïµÔ∏è</div>
            <div class="header-content">
                <h1>üîç ThreatLens</h1>
                <p>Executive Security Intelligence Dashboard</p>
                <div class="tagline">"Detecting Threats Before They Detect You"</div>
            </div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <label>Time Range:</label>
                <select id="timeRange">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="90">Last 90 Days</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Severity:</label>
                <select id="severityFilter">
                    <option value="all">All Severities</option>
                    <option value="critical">Critical Only</option>
                    <option value="high">High & Critical</option>
                    <option value="medium">Medium & Above</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Compliance:</label>
                <select id="complianceFilter">
                    <option value="all">All Standards</option>
                    <option value="PCI-DSS">PCI-DSS</option>
                    <option value="SOC2">SOC2</option>
                    <option value="HIPAA">HIPAA</option>
                    <option value="GDPR">GDPR</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Search:</label>
                <input type="text" id="searchInput" placeholder="Search files, issues...">
            </div>
        </div>

        <div class="stats">
            <div class="stat-card critical">
                <h3 id="criticalCount">0</h3>
                <p>Critical Issues</p>
                <div class="trend" id="criticalTrend">üìà +15% vs last week</div>
            </div>
            <div class="stat-card high">
                <h3 id="highCount">0</h3>
                <p>High Priority</p>
                <div class="trend" id="highTrend">üìâ -8% vs last week</div>
            </div>
            <div class="stat-card medium">
                <h3 id="mediumCount">0</h3>
                <p>Medium Risk</p>
                <div class="trend" id="mediumTrend">‚û°Ô∏è Stable</div>
            </div>
            <div class="stat-card low">
                <h3 id="totalScans">0</h3>
                <p>Total Scans</p>
                <div class="trend" id="scansTrend">üìà +25% automation</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">üìä Security Trends - Leadership View</div>
            <canvas id="trendChart"></canvas>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('recent')">Recent Scans</button>
            <button class="tab" onclick="showTab('issues')">All Issues</button>
            <button class="tab" onclick="showTab('files')">Files Detail</button>
            <button class="tab" onclick="showTab('compliance')">Compliance</button>
        </div>

        <div id="recent" class="tab-content active">
            <div class="table-container">
                <h2>üìÖ Recent Security Scans</h2>
                <div id="loading" class="loading">Loading scan data...</div>
                <table id="scansTable" style="display: none;">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Files Scanned</th>
                            <th>Critical</th>
                            <th>High</th>
                            <th>Medium</th>
                            <th>Low</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="scansTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="issues" class="tab-content">
            <div class="table-container">
                <h2>üö® Security Issues with KB Sources</h2>
                <table id="issuesTable">
                    <thead>
                        <tr>
                            <th>File</th>
                            <th>Line</th>
                            <th>Severity</th>
                            <th>Description</th>
                            <th>Compliance</th>
                            <th>KB Source</th>
                            <th>S3 RFC Path</th>
                        </tr>
                    </thead>
                    <tbody id="issuesTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="files" class="tab-content">
            <div class="table-container">
                <h2>üìÅ Files Analysis</h2>
                <table id="filesTable">
                    <thead>
                        <tr>
                            <th>File Path</th>
                            <th>Type</th>
                            <th>Issues</th>
                            <th>Severity Breakdown</th>
                            <th>Compliance Violations</th>
                        </tr>
                    </thead>
                    <tbody id="filesTableBody">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="compliance" class="tab-content">
            <div class="table-container">
                <h2>üìã Compliance Standards</h2>
                <table id="complianceTable">
                    <thead>
                        <tr>
                            <th>Standard</th>
                            <th>Total Issues</th>
                            <th>Critical</th>
                            <th>High</th>
                            <th>Compliance Score</th>
                            <th>Trend</th>
                        </tr>
                    </thead>
                    <tbody id="complianceTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for detailed view -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Matrix overlay for click animation -->
    <div class="matrix-overlay" id="matrixOverlay">
        <canvas id="overlayCanvas"></canvas>
    </div>

    <script>
        // Matrix Rain Effect (dimmed)
        const canvas = document.getElementById('matrixCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        const fontSize = 12;
        const columns = canvas.width / fontSize;
        const drops = Array(Math.floor(columns)).fill(1);
        
        function draw() {
            ctx.fillStyle = 'rgba(10, 10, 10, 0.04)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#00ff41';
            ctx.font = fontSize + 'px monospace';
            
            for (let i = 0; i < drops.length; i++) {
                const text = letters[Math.floor(Math.random() * letters.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }
        
        setInterval(draw, 35);
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // Data Management
        let allReports = [];
        let filteredReports = [];

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        async function loadReports() {
            try {
                // Try to get list of reports using S3 API format
                const listResponse = await fetch('https://ai-security-scanner-reports-1759503117.s3.amazonaws.com/?list-type=2&prefix=reports/&max-keys=100');
                
                if (!listResponse.ok) {
                    throw new Error('Cannot list S3 objects');
                }
                
                const listText = await listResponse.text();
                console.log('S3 response received');
                
                // Parse S3 XML listing
                const parser = new DOMParser();
                const xml = parser.parseFromString(listText, 'text/xml');
                const keys = Array.from(xml.querySelectorAll('Key'))
                    .map(key => key.textContent)
                    .filter(key => key.endsWith('.json'))
                    .sort()
                    .slice(-50); // Get last 50 reports
                
                console.log('Found report files:', keys.length);
                
                const reports = [];
                for (const key of keys) {
                    try {
                        const reportResponse = await fetch(`https://ai-security-scanner-reports-1759503117.s3.amazonaws.com/${key}`);
                        if (reportResponse.ok) {
                            const report = await reportResponse.json();
                            report.timestamp = key.match(/(\d{8}_\d{6})/)?.[1] || '';
                            reports.push(report);
                        }
                    } catch (e) {
                        console.warn('Failed to load report:', key, e);
                    }
                }

                allReports = reports.length > 0 ? reports : getSampleData();
                console.log('Loaded reports:', allReports.length);
                updateDashboard();
            } catch (error) {
                console.error('Error loading reports, using fallback:', error);
                // Fallback to known recent reports
                const recentReports = [
                    '20251005_161234_compliance_report.json',
                    '20251005_161206_compliance_report.json',
                    '20251005_160924_compliance_report.json',
                    '20251005_160857_compliance_report.json',
                    '20251005_160848_compliance_report.json',
                    '20251005_151803_compliance_report.json',
                    '20251005_151730_compliance_report.json',
                    '20251005_151720_compliance_report.json',
                    '20251005_121054_compliance_report.json'
                ];
                
                const reports = [];
                for (const file of recentReports) {
                    try {
                        const response = await fetch(`https://ai-security-scanner-reports-1759503117.s3.amazonaws.com/reports/${file}`);
                        if (response.ok) {
                            const report = await response.json();
                            report.timestamp = file.replace('_compliance_report.json', '');
                            reports.push(report);
                        }
                    } catch (e) {
                        console.log('Could not load:', file);
                    }
                }
                
                allReports = reports.length > 0 ? reports : getSampleData();
                console.log('Loaded fallback reports:', allReports.length);
                updateDashboard();
            }
        }

        function getSampleData() {
            return [{
                timestamp: '20251005_121054',
                files_scanned: 6,
                total_issues: 28,
                by_severity: { critical: 3, high: 6, medium: 11, low: 8 },
                results: [{
                    filepath: 'src/compliance_scanner.py',
                    issues: [{
                        line: 113,
                        severity: 'critical',
                        description: 'SQL injection vulnerability due to string formatting',
                        compliance_violations: ['PCI-DSS'],
                        kb_rule: 'SQL Injection Prevention',
                        rule_source: 'OWASP Top 10 A03:2021'
                    }]
                }]
            }];
        }

        function applyFilters() {
            const timeRange = parseInt(document.getElementById('timeRange').value);
            const severityFilter = document.getElementById('severityFilter').value;
            const complianceFilter = document.getElementById('complianceFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            console.log('Applying filters:', { timeRange, severityFilter, complianceFilter, searchTerm });
            
            filteredReports = allReports.filter(report => {
                // Time filter
                const reportDate = new Date(report.timestamp.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/, '$1-$2-$3T$4:$5:$6'));
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - timeRange);
                
                if (reportDate < cutoffDate) {
                    console.log('Filtered out by time:', report.timestamp);
                    return false;
                }
                
                // Severity filter
                if (severityFilter !== 'all') {
                    const severities = {
                        'critical': ['critical'],
                        'high': ['critical', 'high'],
                        'medium': ['critical', 'high', 'medium']
                    };
                    
                    const allowedSeverities = severities[severityFilter];
                    const hasSeverity = allowedSeverities.some(sev => (report.by_severity && report.by_severity[sev] || 0) > 0);
                    if (!hasSeverity) {
                        console.log('Filtered out by severity:', report.timestamp);
                        return false;
                    }
                }
                
                // Compliance filter
                if (complianceFilter !== 'all') {
                    let hasCompliance = false;
                    if (report.compliance_summary && report.compliance_summary[complianceFilter]) {
                        hasCompliance = true;
                    }
                    // Also check individual issues
                    if (report.results) {
                        report.results.forEach(result => {
                            if (result.issues) {
                                result.issues.forEach(issue => {
                                    if (issue.compliance_violations && issue.compliance_violations.includes(complianceFilter)) {
                                        hasCompliance = true;
                                    }
                                });
                            }
                        });
                    }
                    if (!hasCompliance) {
                        console.log('Filtered out by compliance:', report.timestamp);
                        return false;
                    }
                }
                
                // Search filter
                if (searchTerm) {
                    const searchableText = JSON.stringify(report).toLowerCase();
                    if (!searchableText.includes(searchTerm)) {
                        console.log('Filtered out by search:', report.timestamp);
                        return false;
                    }
                }
                
                return true;
            });
            
            console.log('Filtered reports:', filteredReports.length, 'of', allReports.length);
        }

        function updateDashboard() {
            applyFilters();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('scansTable').style.display = 'table';

            // Update summary stats from filtered data
            const totals = filteredReports.reduce((acc, report) => {
                acc.critical += report.by_severity?.critical || 0;
                acc.high += report.by_severity?.high || 0;
                acc.medium += report.by_severity?.medium || 0;
                acc.scans += 1;
                return acc;
            }, { critical: 0, high: 0, medium: 0, scans: 0 });

            document.getElementById('criticalCount').textContent = totals.critical;
            document.getElementById('highCount').textContent = totals.high;
            document.getElementById('mediumCount').textContent = totals.medium;
            document.getElementById('totalScans').textContent = totals.scans;

            updateTables();
            drawTrendChart();
        }

        function updateTables() {
            updateScansTable();
            updateIssuesTable();
            updateFilesTable();
            updateComplianceTable();
        }

        function updateScansTable() {
            const tbody = document.getElementById('scansTableBody');
            tbody.innerHTML = '';
            
            filteredReports.slice(-10).reverse().forEach((report, index) => {
                const row = tbody.insertRow();
                row.className = 'clickable-row';
                row.onclick = () => {
                    showMatrixAnimation();
                    setTimeout(() => showDetailModal(report), 500);
                };
                
                // Use scan context if available, fallback to timestamp
                let displayName = '';
                if (report.scan_context) {
                    displayName = report.scan_context.scan_name;
                } else if (report.timestamp) {
                    displayName = report.timestamp.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/, '$1-$2-$3 $4:$5:$6');
                } else {
                    displayName = 'Unknown';
                }
                
                const runner = report.scan_context?.runner || 'Unknown';
                const runnerIcon = runner.includes('GitHub') ? 'üîÑ' : runner.includes('Local') ? 'üíª' : 'ü§ñ';
                
                row.innerHTML = `
                    <td class="timestamp-cell">${runnerIcon} ${displayName}</td>
                    <td>${report.files_scanned}</td>
                    <td><span class="severity-badge severity-critical">${report.by_severity?.critical || 0}</span></td>
                    <td><span class="severity-badge severity-high">${report.by_severity?.high || 0}</span></td>
                    <td><span class="severity-badge severity-medium">${report.by_severity?.medium || 0}</span></td>
                    <td><span class="severity-badge severity-low">${report.by_severity?.low || 0}</span></td>
                    <td>${(report.by_severity?.critical || 0) > 0 ? 'üî¥ Action Required' : '‚úÖ Compliant'}</td>
                `;
            });
        }

        function updateIssuesTable() {
            const tbody = document.getElementById('issuesTableBody');
            tbody.innerHTML = '';
            
            const severityFilter = document.getElementById('severityFilter').value;
            const complianceFilter = document.getElementById('complianceFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredReports.forEach(report => {
                if (report.results) {
                    report.results.forEach(result => {
                        if (result.issues) {
                            result.issues
                                .filter(issue => {
                                    // Severity filter
                                    if (severityFilter !== 'all') {
                                        if (severityFilter === 'critical' && issue.severity !== 'critical') return false;
                                        if (severityFilter === 'high' && !['critical', 'high'].includes(issue.severity)) return false;
                                        if (severityFilter === 'medium' && !['critical', 'high', 'medium'].includes(issue.severity)) return false;
                                    }
                                    
                                    // Compliance filter
                                    if (complianceFilter !== 'all') {
                                        if (!issue.compliance_violations?.includes(complianceFilter)) return false;
                                    }
                                    
                                    // Search filter
                                    if (searchTerm) {
                                        const searchableText = `${result.filepath} ${issue.description} ${issue.compliance_violations?.join(' ') || ''}`.toLowerCase();
                                        if (!searchableText.includes(searchTerm)) return false;
                                    }
                                    
                                    return true;
                                })
                                .forEach(issue => {
                                    const row = tbody.insertRow();
                                    row.innerHTML = `
                                        <td><code>${result.filepath}</code></td>
                                        <td>${issue.line}</td>
                                        <td><span class="severity-badge severity-${issue.severity}">${issue.severity}</span></td>
                                        <td>${issue.description}</td>
                                        <td>${issue.compliance_violations?.join(', ') || 'N/A'}</td>
                                        <td><div class="kb-source">${issue.kb_rule || issue.rule_source || 'N/A'}</div></td>
                                        <td><div class="kb-source">${issue.s3_sources?.map(s => `s3://ai-security-kb-docs-2025/${s}`).join('<br>') || issue.rfc_document || 'N/A'}</div></td>
                                    `;
                                });
                        }
                    });
                }
            });
        }

        function updateFilesTable() {
            const tbody = document.getElementById('filesTableBody');
            tbody.innerHTML = '';
            
            const severityFilter = document.getElementById('severityFilter').value;
            const complianceFilter = document.getElementById('complianceFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            const fileData = {};
            filteredReports.forEach(report => {
                if (report.results) {
                    report.results.forEach(result => {
                        const filepath = result.filepath;
                        if (!fileData[filepath]) {
                            fileData[filepath] = { issues: [], compliance: new Set() };
                        }
                        
                        if (result.issues) {
                            // Apply filters to issues
                            const filteredIssues = result.issues.filter(issue => {
                                // Severity filter
                                if (severityFilter !== 'all') {
                                    if (severityFilter === 'critical' && issue.severity !== 'critical') return false;
                                    if (severityFilter === 'high' && !['critical', 'high'].includes(issue.severity)) return false;
                                    if (severityFilter === 'medium' && !['critical', 'high', 'medium'].includes(issue.severity)) return false;
                                }
                                
                                // Compliance filter
                                if (complianceFilter !== 'all') {
                                    if (!issue.compliance_violations?.includes(complianceFilter)) return false;
                                }
                                
                                // Search filter
                                if (searchTerm) {
                                    const searchableText = `${filepath} ${issue.description} ${issue.compliance_violations?.join(' ') || ''}`.toLowerCase();
                                    if (!searchableText.includes(searchTerm)) return false;
                                }
                                
                                return true;
                            });
                            
                            fileData[filepath].issues.push(...filteredIssues);
                            filteredIssues.forEach(issue => {
                                if (issue.compliance_violations) {
                                    issue.compliance_violations.forEach(cv => fileData[filepath].compliance.add(cv));
                                }
                            });
                        }
                    });
                }
            });
            
            // Only show files that have issues after filtering
            Object.entries(fileData).forEach(([filepath, data]) => {
                if (data.issues.length === 0) return; // Skip files with no issues after filtering
                
                const severityBreakdown = data.issues.reduce((acc, issue) => {
                    acc[issue.severity] = (acc[issue.severity] || 0) + 1;
                    return acc;
                }, {});
                
                const fileType = filepath.split('.').pop().toUpperCase();
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><code>${filepath}</code></td>
                    <td><span class="severity-badge severity-low">${fileType}</span></td>
                    <td>${data.issues.length}</td>
                    <td>
                        ${severityBreakdown.critical ? `<span class="severity-badge severity-critical">${severityBreakdown.critical}</span> ` : ''}
                        ${severityBreakdown.high ? `<span class="severity-badge severity-high">${severityBreakdown.high}</span> ` : ''}
                        ${severityBreakdown.medium ? `<span class="severity-badge severity-medium">${severityBreakdown.medium}</span> ` : ''}
                        ${severityBreakdown.low ? `<span class="severity-badge severity-low">${severityBreakdown.low}</span> ` : ''}
                    </td>
                    <td>${Array.from(data.compliance).join(', ')}</td>
                `;
            });
        }

        function updateComplianceTable() {
            const tbody = document.getElementById('complianceTableBody');
            tbody.innerHTML = '';
            
            const complianceData = {};
            filteredReports.forEach(report => {
                if (report.compliance_summary) {
                    Object.entries(report.compliance_summary).forEach(([standard, data]) => {
                        if (!complianceData[standard]) {
                            complianceData[standard] = { total: 0, critical: 0, high: 0 };
                        }
                        complianceData[standard].total += data.issues || 0;
                        complianceData[standard].critical += data.critical || 0;
                        complianceData[standard].high += data.high || 0;
                    });
                }
            });
            
            Object.entries(complianceData).forEach(([standard, data]) => {
                const score = Math.max(0, 100 - (data.critical * 10 + data.high * 5));
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${standard}</td>
                    <td>${data.total}</td>
                    <td><span class="severity-badge severity-critical">${data.critical}</span></td>
                    <td><span class="severity-badge severity-high">${data.high}</span></td>
                    <td>${score}%</td>
                    <td>${score > 80 ? 'üìà Improving' : 'üìâ Needs Attention'}</td>
                `;
            });
        }

        function drawTrendChart() {
            const canvas = document.getElementById('trendChart');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size to match container exactly
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            
            const width = rect.width;
            const height = rect.height;
            
            ctx.clearRect(0, 0, width, height);
            
            // Get filtered data
            const severityFilter = document.getElementById('severityFilter').value;
            const complianceFilter = document.getElementById('complianceFilter').value;
            
            let criticalCount = 0, highCount = 0, mediumCount = 0, lowCount = 0;
            
            filteredReports.forEach(report => {
                if (report.results) {
                    report.results.forEach(result => {
                        if (result.issues) {
                            result.issues.forEach(issue => {
                                if (severityFilter !== 'all') {
                                    if (severityFilter === 'critical' && issue.severity !== 'critical') return;
                                    if (severityFilter === 'high' && !['critical', 'high'].includes(issue.severity)) return;
                                    if (severityFilter === 'medium' && !['critical', 'high', 'medium'].includes(issue.severity)) return;
                                }
                                
                                if (complianceFilter !== 'all') {
                                    if (!issue.compliance_violations?.includes(complianceFilter)) return;
                                }
                                
                                switch(issue.severity) {
                                    case 'critical': criticalCount++; break;
                                    case 'high': highCount++; break;
                                    case 'medium': mediumCount++; break;
                                    case 'low': lowCount++; break;
                                }
                            });
                        }
                    });
                }
            });
            
            const data = [
                { label: 'Critical', value: criticalCount, color: '#ff4444' },
                { label: 'High', value: highCount, color: '#ff8800' },
                { label: 'Medium', value: mediumCount, color: '#ffcc00' },
                { label: 'Low', value: lowCount, color: '#00ff41' }
            ];
            
            const maxValue = Math.max(...data.map(d => d.value)) || 1;
            const padding = 40;
            const barWidth = (width - padding * 2) / 6;
            const chartHeight = height - 80;
            const startX = padding;
            const startY = 20;
            
            // Draw bars
            data.forEach((item, index) => {
                const barHeight = (item.value / maxValue) * chartHeight;
                const x = startX + (index * barWidth * 1.2);
                const y = startY + chartHeight - barHeight;
                
                // Draw bar with sharp edges
                ctx.fillStyle = item.color;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Draw value on top
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.value.toString(), x + barWidth/2, y - 8);
                
                // Draw label
                ctx.fillStyle = '#e0e0e0';
                ctx.font = '12px Arial';
                ctx.fillText(item.label, x + barWidth/2, height - 10);
            });
        }

        // Modal functions
        function showDetailModal(report) {
            const modal = document.getElementById('detailModal');
            const modalContent = document.getElementById('modalContent');
            
            // Use scan context for title
            let title = 'üîç Detailed Scan Report';
            if (report.scan_context) {
                title += ` - ${report.scan_context.scan_name}`;
                if (report.scan_context.runner) {
                    title += ` (${report.scan_context.runner})`;
                }
            } else if (report.timestamp) {
                const timestamp = report.timestamp.replace(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/, '$1-$2-$3 $4:$5:$6');
                title += ` - ${timestamp}`;
            }
            
            let html = `<h2>${title}</h2>`;
            
            // Add scan context section if available
            if (report.scan_context) {
                html += `
                    <div class="detail-section">
                        <div class="detail-title">üè∑Ô∏è Scan Context</div>
                        <p><strong>Runner:</strong> ${report.scan_context.runner}</p>
                        ${report.scan_context.repo_name ? `<p><strong>Repository:</strong> ${report.scan_context.repo_name}</p>` : ''}
                        ${report.scan_context.branch_name ? `<p><strong>Branch:</strong> ${report.scan_context.branch_name}</p>` : ''}
                        ${report.scan_context.pr_number ? `<p><strong>Pull Request:</strong> #${report.scan_context.pr_number}</p>` : ''}
                        <p><strong>Scan Date:</strong> ${report.scan_date || report.timestamp}</p>
                    </div>
                `;
            }
            
            html += `
                <div class="detail-section">
                    <div class="detail-title">üìä Summary</div>
                    <p><strong>Files Scanned:</strong> ${report.files_scanned || 0}</p>
                    <p><strong>Total Issues:</strong> ${report.total_issues || 0}</p>
                    <p><strong>AI Calls:</strong> ${report.ai_calls || 0}</p>
                    <p><strong>Cost:</strong> $${report.cost?.toFixed(4) || '0.0000'}</p>
                </div>
                
                <div class="detail-section">
                    <div class="detail-title">üéØ Severity Breakdown</div>
                    <ul style="list-style: none; padding-left: 0;">
                        <li style="margin-bottom: 8px;">‚Ä¢ <span class="severity-badge severity-critical">${report.by_severity?.critical || 0}</span> Critical Issues</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ <span class="severity-badge severity-high">${report.by_severity?.high || 0}</span> High Priority Issues</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ <span class="severity-badge severity-medium">${report.by_severity?.medium || 0}</span> Medium Risk Issues</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ <span class="severity-badge severity-low">${report.by_severity?.low || 0}</span> Low Priority Issues</li>
                    </ul>
                </div>
            `;
            
            if (report.compliance_summary) {
                html += `
                    <div class="detail-section">
                        <div class="detail-title">üìã Compliance Summary</div>
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="padding: 8px; border: 1px solid #333;">Standard</th>
                                    <th style="padding: 8px; border: 1px solid #333;">Issues</th>
                                    <th style="padding: 8px; border: 1px solid #333;">Critical</th>
                                    <th style="padding: 8px; border: 1px solid #333;">High</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                Object.entries(report.compliance_summary).forEach(([standard, data]) => {
                    html += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #333;">${standard}</td>
                            <td style="padding: 8px; border: 1px solid #333;">${data.issues || 0}</td>
                            <td style="padding: 8px; border: 1px solid #333;"><span class="severity-badge severity-critical">${data.critical || 0}</span></td>
                            <td style="padding: 8px; border: 1px solid #333;"><span class="severity-badge severity-high">${data.high || 0}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            if (report.results && report.results.length > 0) {
                html += `
                    <div class="detail-section">
                        <div class="detail-title">üìÅ Files and Issues Analysis</div>
                `;
                
                report.results.forEach(result => {
                    html += `
                        <div class="detail-item">
                            <h4>üìÑ ${result.filepath}</h4>
                    `;
                    
                    if (result.issues && result.issues.length > 0) {
                        result.issues.forEach(issue => {
                            html += `
                                <div class="detail-issue">
                                    <p><strong>Line ${issue.line}:</strong> <span class="severity-badge severity-${issue.severity}">${issue.severity.toUpperCase()}</span></p>
                                    
                                    <p><strong>Issue Description:</strong><br>${issue.description}</p>
                                    
                                    <p><strong>Compliance Violations:</strong><br>${issue.compliance_violations?.join(', ') || 'N/A'}</p>
                                    
                                    <p><strong>Knowledge Base Source:</strong><br>${issue.kb_rule || issue.rule_source || 'N/A'}</p>
                                    
                                    <p><strong>S3 RFC Documentation:</strong><br>${issue.s3_sources?.map(s => `s3://ai-security-kb-docs-2025/${s}`).join('<br>') || 'N/A'}</p>
                                    
                                    ${issue.remediation ? `<p><strong>Recommended Fix:</strong><br>${issue.remediation}</p>` : ''}
                                </div>
                            `;
                        });
                    } else {
                        html += `<p style="margin-left: 20px; color: #00ff41; padding: 10px;">‚úÖ No security issues detected in this file</p>`;
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            }
            
            modalContent.innerHTML = html;
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Matrix animation overlay
        function showMatrixAnimation() {
            const overlay = document.getElementById('matrixOverlay');
            const canvas = document.getElementById('overlayCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            overlay.style.display = 'block';
            
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const fontSize = 16;
            const columns = canvas.width / fontSize;
            const drops = Array(Math.floor(columns)).fill(1);
            
            let animationCount = 0;
            const maxAnimations = 60; // 2 seconds at 30fps
            
            function animateMatrix() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#00ff41';
                ctx.font = fontSize + 'px monospace';
                
                for (let i = 0; i < drops.length; i++) {
                    const text = letters[Math.floor(Math.random() * letters.length)];
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                    
                    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                        drops[i] = 0;
                    }
                    drops[i]++;
                }
                
                animationCount++;
                if (animationCount < maxAnimations) {
                    requestAnimationFrame(animateMatrix);
                } else {
                    overlay.style.display = 'none';
                    animationCount = 0;
                }
            }
            
            animateMatrix();
        }

        // Add click listeners for Matrix animation
        function addMatrixClickListeners() {
            // Matrix animation only for timestamp clicks (handled in updateScansTable)
        }

        // Event Listeners
        document.getElementById('timeRange').addEventListener('change', updateDashboard);
        document.getElementById('severityFilter').addEventListener('change', updateDashboard);
        document.getElementById('complianceFilter').addEventListener('change', updateDashboard);
        document.getElementById('searchInput').addEventListener('input', updateDashboard);

        // Initialize
        window.addEventListener('load', () => {
            loadReports();
            addMatrixClickListeners();
        });
    </script>
</body>
</html>
